name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.1"

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Run luacheck
        run: luacheck lua/ plugin/ --globals vim --no-max-line-length

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install lua-language-server
        run: |
          mkdir -p ~/.local/bin
          # Try to get the latest release
          LATEST_URL=$(curl -s https://api.github.com/repos/LuaLS/lua-language-server/releases/latest | grep "browser_download_url.*linux-x64" | cut -d '"' -f 4 || echo "")
          if [ -n "$LATEST_URL" ]; then
            curl -L "$LATEST_URL" | tar xz -C ~/.local || true
          else
            # Fallback to known version
            curl -L https://github.com/LuaLS/lua-language-server/releases/download/3.7.4/lua-language-server-3.7.4-linux-x64.tar.gz | tar xz -C ~/.local || true
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        shell: bash

      - name: Run type check
        run: |
          if [ ! -f ~/.local/bin/lua-language-server ]; then
            echo "lua-language-server not installed, skipping type check"
            exit 0
          fi
          
          cat > .luarc.json << 'EOF'
          {
            "runtime": {
              "version": "LuaJIT"
            },
            "workspace": {
              "library": [
                "$VIMRUNTIME/lua",
                "${3rd}/luv/library"
              ],
              "checkThirdParty": false
            },
            "diagnostics": {
              "globals": ["vim"]
            }
          }
          EOF
          ~/.local/bin/lua-language-server --check lua/ || true
        shell: bash

  vimdoc:
    name: Vimdoc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate vimdoc
        run: |
          # Check that doc file exists
          test -f doc/snacks-explorer-mouse.txt

          # Check for required sections
          grep -q "CONTENTS" doc/snacks-explorer-mouse.txt
          grep -q "INTRODUCTION" doc/snacks-explorer-mouse.txt
          grep -q "INSTALLATION" doc/snacks-explorer-mouse.txt
          grep -q "CONFIGURATION" doc/snacks-explorer-mouse.txt

  test:
    name: Test (Neovim ${{ matrix.neovim }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        neovim: ["v0.9.5", "v0.10.2", "nightly"]
    steps:
      - uses: actions/checkout@v4

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: ${{ matrix.neovim }}

      - name: Run tests
        run: |
          # Create minimal init.vim for testing
          cat > /tmp/test_init.vim << 'EOF'
          set rtp+=.
          set rtp+=./tests
          lua require('snacks-explorer-mouse')
          quit
          EOF
          
          # Basic smoke test - check plugin loads without errors
          nvim --headless -u /tmp/test_init.vim 2>&1 | tee output.txt || true
          
          # Check for actual errors (not just info messages)
          if grep -iE "(E\d+:|error:|stack traceback|failed)" output.txt | grep -v "^$"; then
            echo "Errors found in output"
            cat output.txt
            exit 1
          else
            echo "No critical errors found - tests passed"
          fi
